<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Satellite Globe (Gestures)</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />

    <!-- MediaPipe Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: sans-serif;
        }

        #map {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #gesture-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 10;
            font-weight: 500;
        }

        .glass-btn {
            pointer-events: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #ui-layer {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
            pointer-events: none;
        }

        #camera-feed-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 240px;
            height: 180px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            display: none;
            z-index: 20;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Hide specific Mapbox UI if desired */
        .mapboxgl-ctrl-logo,
        .mapboxgl-ctrl-attrib {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="gesture-status">Gestures: Rotate (Left/Right) | Zoom (Pinch/Open)</div>
    <div id="map"></div>

    <div id="ui-layer">
        <div id="controls-container">
            <button id="cameraBtn" class="glass-btn">Start Camera & Gestures</button>
        </div>
    </div>

    <div id="camera-feed-container">
        <video id="camera-video" playsinline></video>
    </div>

    <script>
        // 1. Mapbox Setup
        mapboxgl.accessToken = 'pk.eyJ1IjoibW9oYW1tZWQtMTMzMSIsImEiOiJjbWlsaWh1anAxM2kzM2dyNHR5eTU4am9hIn0.arsZikWNpuoceyWdnM30VA';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-v9', // Default Satellite Style
            projection: 'globe',
            zoom: 1.5,
            center: [30, 15],
            pitch: 0,
        });

        // Add Atmosphere
        map.on('style.load', () => {
            map.setFog({
                'color': 'rgb(186, 210, 235)',
                'high-color': 'rgb(36, 92, 223)',
                'horizon-blend': 0.02,
                'space-color': 'rgb(11, 11, 25)',
                'star-intensity': 0.6
            });
        });

        // 2. Gesture State
        let handDeltaX = 0; // Rotate Speed
        let handDeltaY = 0; // Zoom Speed

        let videoElement, hands;

        // 3. Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            if (!map) return;

            // Handle Rotation
            if (Math.abs(handDeltaX) > 0.05) {
                const currentBearing = map.getBearing();
                map.easeTo({
                    bearing: currentBearing - (handDeltaX * 2.0), // Speed multiplier
                    duration: 0,
                    easing: t => t
                });
            }

            // Handle Zoom
            if (Math.abs(handDeltaY) > 0.05) {
                const currentZoom = map.getZoom();
                // handDeltaY > 0 (Positive) -> Zoom Out
                // handDeltaY < 0 (Negative) -> Zoom In
                const zoomMove = -(handDeltaY * 0.1); // Small incremental zoom

                map.easeTo({
                    zoom: currentZoom + zoomMove,
                    duration: 0,
                    easing: t => t
                });
            }
        }
        animate();

        // 4. MediaPipe Logic
        function onResults(results) {
            const statusEl = document.getElementById('gesture-status');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                statusEl.style.opacity = 1;
                const landmarks = results.multiHandLandmarks[0];

                // Rotation (Index Finger X)
                const x = landmarks[8].x;
                const xOffset = x - 0.5;

                if (Math.abs(xOffset) > 0.05) {
                    handDeltaX = xOffset;
                    statusEl.innerText = xOffset > 0 ? "Rotate Right >>" : "<< Rotate Left";
                } else {
                    handDeltaX = 0;
                }

                // Zoom (Pinch Distance)
                const thumb = landmarks[4];
                const index = landmarks[8];
                const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));

                const pinchThresh = 0.06;
                const openThresh = 0.15;

                if (dist < pinchThresh) {
                    handDeltaY = 0.8; // Signal Zoom Out
                    statusEl.innerText += " [Zoom Out]";
                } else if (dist > openThresh) {
                    handDeltaY = -0.8; // Signal Zoom In
                    statusEl.innerText += " [Zoom In]";
                } else {
                    handDeltaY = 0; // Hold
                }

                if (handDeltaX === 0 && handDeltaY === 0) {
                    statusEl.innerText = "Holding Position";
                }

            } else {
                handDeltaX = 0;
                handDeltaY = 0;
                statusEl.style.opacity = 0.5;
                statusEl.innerText = "Show hand to control";
            }
        }

        // 5. Camera & Setup
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, facingMode: "user" } });
                videoElement = document.getElementById('camera-video');
                videoElement.srcObject = stream;
                await videoElement.play();

                hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
                hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.5 });
                hands.onResults(onResults);

                document.getElementById('cameraBtn').style.display = 'none';
                document.getElementById('camera-feed-container').style.display = 'block';

                // Loop
                const process = async () => {
                    if (videoElement && !videoElement.paused) {
                        try { await hands.send({ image: videoElement }); } catch (e) { }
                        requestAnimationFrame(process);
                    }
                };
                process();

            } catch (e) {
                alert("Camera Error: " + e.message);
            }
        }

        document.getElementById('cameraBtn').addEventListener('click', startCamera);

    </script>
</body>

</html>
